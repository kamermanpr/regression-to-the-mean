---
title: "Regression to the mean modeling"
subtitle: "Mean pain rating of 6.2 at 0.2 correlation"
author: "Peter Kamerman"
date: "Last knitted: `r format(Sys.Date(), '%d %B %Y')`"
geometry: margin=15mm
---

```{r include = FALSE}
# Load packages
library(tidyverse)
library(magrittr)
library(MASS)
library(rcompanion)
library(ggExtra)
library(MBESS)
library(knitr)
library(patchwork)

# Set ggplot theme
theme_set(new = theme_bw(base_size = 20)) 
theme_update(legend.text = element_text(size = 14),
             axis.text = element_text(colour = '#000000',
                                      size = 20),
             axis.title = element_text(size = 20),
             panel.grid = element_blank(),
             plot.caption = element_text(size = 12),
             plot.title = element_text(size = 20),
             plot.subtitle = element_text(size = 16))

# Palette
pal <- c('#2678B2', '#FD7F28')

# Output options
if(!dir.exists('figures')){
  dir.create('figures')  
} 

if(!dir.exists('figures/six.two_02')){
  dir.create('figures/six.two_02')  
} 

opts_chunk$set(fig.height = 8,
               fig.width = 8,
               fig.path = 'figures/six.two_02/')
```

# Generate 2x2 covariance matrix 

Generate a covariance matrix using an SD of 1.2, 1.7, and 2.2, and correlation of 0.2.

```{r cov_matrix}
# Correlation matrix
cor <- matrix(c(1, 0.2, 0.2, 1), ncol = 2)

# SDs
std_1 <- c(1.2, 1.2)
std_2 <- c(1.7, 1.7)
std_3 <- c(2.2, 2.2)

# Covariance matrices
cov_1 <- cor2cov(cor.mat = cor,
                 sd = std_1)
cov_1
cov_2 <- cor2cov(cor.mat = cor,
                 sd = std_2)
cov_2
cov_3 <- cor2cov(cor.mat = cor,
                 sd = std_3)
cov_3
```

----

# Mean = 6.2, SD = 1.2, r = 0.2

## Generate and summarise data

### Base data

```{r one_base}
# Set the random seed for reproducibility
set.seed(2019)

# Generate the data
six_1.base <- as.data.frame(mvrnorm(n = 1000, mu = c(6.2, 6.2), Sigma = cov_1))

# Plot base data
ggMarginal(ggplot(data = six_1.base) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_1.base$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_1.base$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_1.base$V1, 
                                         six_1.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_1.base$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_1.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_1.base$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_1.base$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_1.base$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_1.base$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_1.base$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_1.base$V1), 2)}")) +
               labs(title = 'A: Unconstained',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

### Constrain values to 0-10 range

```{r one_constrained}
# Process data
six_1 <- six_1.base %>%
    mutate(V1 = case_when(
               V1 < 1 ~ 1,
               V1 > 10 ~ 10,
               TRUE ~ V1)) %>% 
    mutate(V2 = case_when(
               V2 < 0 ~ 0,
               V2 > 10 ~ 10,
               TRUE ~ V2)) %>% 
    mutate(group = 'No threshold')

# Plot processed data
ggMarginal(ggplot(data = six_1) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_1$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_1$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_1$V1, 
                                         six_1$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_1$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_1$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_1$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_1$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_1$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5, 
                        label = str_glue("Mean = {round(mean(six_1$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_1$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_1$V1), 2)}")) +
               labs(title = 'B: Constrained (0-10 range)',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

## Model mean of V1 with increasing V1 thresholds from 0 to 5 

```{r one_cutoffV1V1}
# Extract visit 1 data 
six_1V1 <- six_1$V1

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V1 means at each V1 threshold
six_1V1.shift <- sapply(cutoff, function(x){mean(six_1V1[six_1V1 > x])})

# Calculate deviation 
(six_1V1.df <- data.frame(time = 'V1',
                           cutoff = cutoff,
                           cutoff2 = cutoff - 0.15,
                           mean = six_1V1.shift) %>% 
        mutate(deviation = mean - mean(six_1V1),
               time = as.character(time)))

# Plot data
ggplot(data = six_1V1.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_1V1), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 5) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'A: Shift in V1 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Model mean of V2 with increasing V1 thresholds from 0 to 5 

```{r one_cutoffV1V2}
# Extract visit 2 data 
six_1V2 <- six_1$V2

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V2 means at each V1 threshold
six_1V2.shift <- map_dbl(.x = cutoff,
                          ~ six_1 %>% 
                              filter(V1 > .x) %>% 
                              .$V2 %>% 
                              mean(.))

# Calculate deviation
(six_1V2.df <- data.frame(time = 'V2',
                           cutoff = cutoff,
                           cutoff2 = cutoff + 0.15,
                           mean = six_1V2.shift) %>% 
        mutate(deviation = mean - mean(six_1V2),
               time = as.character(time)))

# Plot data
ggplot(data = six_1V2.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_1V2), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 5) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'B: Shift in V2 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Placebo response

### threshold: 0

```{r one_threshold0}
# Process data
placebo_1.0 <- six_1 %>% 
    filter(V1 >= 0) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Calculate the mean (95%CI) difference between V1 and V2
diff_1.0 <- groupwiseMean(difference ~ 1,
                          data = placebo_1.0,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_1.0$.id <- 0

kable(diff_1.0)

# Plot the data
ggMarginal(placebo_1.0[, 1:3] %>% 
               bind_rows(six_1) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_1,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_1.0,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_1$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_1.0$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 0, linetype = 2) +
               geom_hline(yintercept = mean(six_1$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_1.0$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'A: Baseline pain threshold = 0',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 3

```{r one_threshold3}
# Process data
placebo_1.3 <- six_1 %>% 
    filter(V1 >= 3) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Calculate the mean (95%CI) difference between V1 and V2
diff_1.3 <- groupwiseMean(difference ~ 1,
                          data = placebo_1.3,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_1.3$.id <- 3

kable(diff_1.3)

# Plot the data
ggMarginal(placebo_1.3[, 1:3] %>% 
               bind_rows(six_1) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_1,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_1.3,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_1$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_1.3$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 3, linetype = 2) +
               geom_hline(yintercept = mean(six_1$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_1.3$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'B: Baseline pain threshold = 3',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15), 
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 4

```{r one_threshold4}
# Process that data
placebo_1.4 <- six_1 %>% 
    filter(V1 >= 4) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_1.4 <- groupwiseMean(difference ~ 1,
                          data = placebo_1.4,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_1.4$.id <- 4

kable(diff_1.4)

# Plot the data
ggMarginal(placebo_1.4[, 1:3] %>% 
               bind_rows(six_1) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_1,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_1.4,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_1$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_1.4$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 4, linetype = 2) +
               geom_hline(yintercept = mean(six_1$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_1.4$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'C: Baseline pain threshold = 4',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 5

```{r one_threshold5}
# Process that data 
placebo_1.5 <- six_1 %>% 
    filter(V1 >= 5) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_1.5 <- groupwiseMean(difference ~ 1,
                          data = placebo_1.5,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_1.5$.id <- 5

kable(diff_1.5)

# Plot the data
ggMarginal(placebo_1.5[, 1:3] %>% 
               bind_rows(six_1) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_1,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_1.5,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_1$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_1.5$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 5, linetype = 2) +
               geom_hline(yintercept = mean(six_1$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_1.5$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'D: Baseline pain threshold = 5',
                    caption = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

## Publication plots

```{r one_plot0}
# Plot 1
shift_1 <- six_1V1.df %>% 
  bind_rows(six_1V2.df) %>% 
  ggplot(data = .) + 
  aes(y = mean,
      x = cutoff2,
      fill= time) +
  geom_hline(yintercept = 6.2,
             linetype = 2) +
  geom_point(shape = 21,
             size = 8) +
  labs(title = 'A',
       subtitle = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean pain score (0-10 rating scale)') +
  scale_x_continuous(breaks = 0:5) +
  scale_y_continuous(limits = c(4, 10)) +
  scale_fill_manual(values = pal) +
  theme(legend.title = element_blank(),
        legend.position = c(0.12, 0.89),
        legend.text = element_text(size = 20)); shift_1
  
# Plot 2
# Bind diff_*.* dataframes
diff_all_1 <- diff_1.0 %>% 
  bind_rows(diff_1.3, diff_1.4, diff_1.5)

pp_1 <- diff_all_1 %>% 
  mutate(Threshold = factor(.id)) %>% 
  ggplot(data = .) +
  aes(x = Threshold,
      y = Mean,
      ymin = Bca.lower,
      ymax = Bca.upper) +
  geom_hline(yintercept = 0, 
             linetype = 2) +
  geom_errorbar(width = 0.4) +
  geom_point(shape = 21,
             fill = pal[[1]],
             size = 8) +
  labs(title = 'A',
       subtitle = 'Parameters: Mean = 6.2, SD = 1.2, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean difference (V1 - V2)') +
  scale_y_continuous(limits = c(-0.2, 1.8)); pp_1
```

----

# Mean = 6.2, SD = 1.7, r = 0.2

## Generate and summarise data

### Base data

```{r two_base}
# Set the random seed for reproducibility
set.seed(2019)

# Generate the data
six_2.base <- as.data.frame(mvrnorm(n = 1000, mu = c(6.2, 6.2), Sigma = cov_2))

# Plot base data
ggMarginal(ggplot(data = six_2.base) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_2.base$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_2.base$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_2.base$V1, 
                                         six_2.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_2.base$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_2.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_2.base$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_2.base$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_2.base$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_2.base$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_2.base$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_2.base$V1), 2)}")) +
               labs(title = 'A: Unconstrained',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

### Constrain values to 0-10 range

```{r two_constrained}
# Process data
six_2 <- six_2.base %>%
    mutate(V1 = case_when(
               V1 < 1 ~ 1,
               V1 > 10 ~ 10,
               TRUE ~ V1)) %>% 
    mutate(V2 = case_when(
               V2 < 0 ~ 0,
               V2 > 10 ~ 10,
               TRUE ~ V2)) %>% 
    mutate(group = 'No threshold')

# Plot processed data
ggMarginal(ggplot(data = six_2) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_2$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_2$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_2$V1, 
                                         six_2$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_2$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_2$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_2$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_2$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_2$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_2$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_2$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_2$V1), 2)}")) +
               labs(title ='B: Constrained (0-10 range)',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

## Model mean of V1 with increasing V1 thresholds from 0 to 5 

```{r two_cutoffV1V1}
# Extract visit 1 data 
six_2V1 <- six_2$V1

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V1 means at each V1 threshold
six_2V1.shift <- sapply(cutoff, function(x){mean(six_2V1[six_2V1 > x])})

# Calculate deviation 
(six_2V1.df <- data.frame(time = 'V1',
                           cutoff = cutoff,
                           cutoff2 = cutoff - 0.15,
                           mean = six_2V1.shift) %>% 
        mutate(deviation = mean - mean(six_2V1),
               time = as.character(time)))

# Plot data
ggplot(data = six_2V1.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_2V1), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 5) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'A: Shift in V1 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Model mean of V2 with increasing V1 thresholds from 0 to 5 

```{r two_cutoffV1V2}
# Extract visit 2 data 
six_2V2 <- six_2$V2

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V2 means at each V1 threshold
six_2V2.shift <- map_dbl(.x = cutoff,
                          ~ six_2 %>% 
                              filter(V1 > .x) %>% 
                              .$V2 %>% 
                              mean(.))

# Calculate deviation
(six_2V2.df <- data.frame(time = 'V2',
                           cutoff = cutoff,
                           cutoff2 = cutoff + 0.15,
                           mean = six_2V2.shift) %>% 
        mutate(deviation = mean - mean(six_2V2),
               time = as.character(time)))

# Plot data
ggplot(data = six_2V2.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_2V2), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 5) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'B: Shift in V2 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Placebo response

### threshold: 0

```{r two_threshold0}
# Process data
placebo_2.0 <- six_2 %>% 
    filter(V1 >= 0) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Calculate the mean (95%CI) difference between V1 and V2
diff_2.0 <- groupwiseMean(difference ~ 1,
                          data = placebo_2.0,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_2.0$.id <- 0

kable(diff_2.0)

# Plot the data
ggMarginal(placebo_2.0[, 1:3] %>% 
               bind_rows(six_2) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_2,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_2.0,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_2$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_2.0$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 0, linetype = 2) +
               geom_hline(yintercept = mean(six_2$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_2.0$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'A: Baseline pain threshold = 0',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 3

```{r two_threshold3}
# Process data
placebo_2.3 <- six_2 %>% 
    filter(V1 >= 3) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_2.3 <- groupwiseMean(difference ~ 1,
                          data = placebo_2.3,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_2.3$.id <- 3

kable(diff_2.3)

# Plot the data
ggMarginal(placebo_2.3[, 1:3] %>% 
               bind_rows(six_2) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_2,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_2.3,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_2$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_2.3$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 3, linetype = 2) +
               geom_hline(yintercept = mean(six_2$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_2.3$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'B: Baseline pain threshold = 3',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 4

```{r two_threshold4}
# Process that data
placebo_2.4 <- six_2 %>% 
    filter(V1 >= 4) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_2.4 <- groupwiseMean(difference ~ 1,
                          data = placebo_2.4,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_2.4$.id <- 4

kable(diff_2.4)

# Plot the data
ggMarginal(placebo_2.4[, 1:3] %>% 
               bind_rows(six_2) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_2,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_2.4,
                          colour = '#000000',
                          size = 1) +
               geom_vline(xintercept = mean(six_2$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_2.4$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 4, linetype = 2) +
               geom_hline(yintercept = mean(six_2$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_2.4$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'C: Baseline pain threshold = 4',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 5

```{r two_threshold5}
# Process that data 
placebo_2.5 <- six_2 %>% 
    filter(V1 >= 5) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_2.5 <- groupwiseMean(difference ~ 1,
                          data = placebo_2.5,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_2.5$.id <- 5

kable(diff_2.5)

# Plot the data
ggMarginal(placebo_2.5[, 1:3] %>% 
               bind_rows(six_2) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_2,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_2.5,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_2$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_2.5$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 5, linetype = 2) +
               geom_hline(yintercept = mean(six_2$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_2.5$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'D: Baseline pain threshold = 5',
                    caption = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

## Publication plots

```{r two_plot0}
# Plot 1
shift_2 <- six_2V1.df %>% 
  bind_rows(six_2V2.df) %>% 
  ggplot(data = .) + 
  aes(y = mean,
      x = cutoff2,
      fill = time) +
  geom_hline(yintercept = 6.2,
             linetype = 2) +
  geom_point(shape = 21,
             size = 8) +
  labs(title = 'B',
       subtitle = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean pain score (0-10 rating scale)') +
  scale_x_continuous(breaks = 0:5) +
  scale_y_continuous(limits = c(4, 10)) +
  scale_fill_manual(values = pal) +
  theme(legend.title = element_blank(),
        legend.position = c(0.12, 0.89),
        legend.text = element_text(size = 20)); shift_2
  
# Plot 2
# Bind diff_*.* dataframes
diff_all_2 <- diff_2.0 %>% 
  bind_rows(diff_2.3, diff_2.4, diff_2.5)

pp_2 <- diff_all_2 %>% 
  mutate(Threshold = factor(.id)) %>% 
  ggplot(data = .) +
  aes(x = Threshold,
      y = Mean,
      ymin = Bca.lower,
      ymax = Bca.upper) +
  geom_hline(yintercept = 0, 
             linetype = 2) +
  geom_errorbar(width = 0.4) +
  geom_point(shape = 21,
             fill = pal[[1]],
             size = 8) +
  labs(title = 'B',
       subtitle = 'Parameters: Mean = 6.2, SD = 1.7, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean difference (V1 - V2)') +
  scale_y_continuous(limits = c(-0.2, 1.8)); pp_2
```

----

# Mean = 6.2, SD = 2.2, r = 0.2

## Generate and summarise data

### Base data

```{r three_base}
# Set the random seed for reproducibility
set.seed(2019)

# Generate the data
six_3.base <- as.data.frame(mvrnorm(n = 1000, mu = c(6.2, 6.2), Sigma = cov_3))

# Plot base data
ggMarginal(ggplot(data = six_3.base) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_3.base$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_3.base$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, 
                        hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_3.base$V1, 
                                         six_3.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_3.base$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_3.base$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_3.base$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_3.base$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_3.base$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_3.base$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_3.base$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_3.base$V1), 2)}")) +
               labs(title = 'A: Unconstrained',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

### Constrain values to 0-10 range

```{r three_constrained}
# Process data
six_3 <- six_3.base %>%
    mutate(V1 = case_when(
               V1 < 1 ~ 1,
               V1 > 10 ~ 10,
               TRUE ~ V1)) %>% 
    mutate(V2 = case_when(
               V2 < 0 ~ 0,
               V2 > 10 ~ 10,
               TRUE ~ V2)) %>% 
    mutate(group = 'No threshold')

# Plot processed data
ggMarginal(ggplot(data = six_3) +
               aes(x = V1, y = V2) + 
               geom_point() + 
               geom_hline(yintercept = mean(six_3$V2), 
                          colour = 'red', size = 1) +
               geom_vline(xintercept = mean(six_3$V1), 
                          colour = 'red', size = 1) +
               geom_rect(ymin = 0, ymax = 10, 
                         xmin = 0, xmax = 10, 
                         colour = '#000000',
                         alpha = 0,
                         linetype = 2) +
               annotate(geom = 'text', x = -5, y = 15, 
                        hjust = 0, size = 5,
                        label = str_glue("r = {round(cor(six_3$V1, 
                                         six_3$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_3$V2) + 1.7, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_3$V2), 2)}")) +
               annotate(geom = 'text', x = -5, y = mean(six_3$V2) + 0.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_3$V2),2)}")) +
               annotate(geom = 'text', x = mean(six_3$V1) + 0.2, y = -3.8, 
                        hjust = 0, size = 5,
                        label = str_glue("Mean = {round(mean(six_3$V1), 2)}")) +
               annotate(geom = 'text', x = mean(six_3$V1) + 0.2, y = -4.75, 
                        hjust = 0, size = 5,
                        label = str_glue("SD = {round(sd(six_3$V1), 2)}")) +
               labs(title = 'B: Constrained (0-10 range)',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               scale_y_continuous(limits = c(-5, 15)) +
               scale_x_continuous(limits = c(-5, 15)) +
               theme(plot.caption = element_text(size = 14)))
```

## Model mean of V1 with increasing V1 thresholds from 0 to 5 

```{r three_cutoffV1V1}
# Extract visit 1 data 
six_3V1 <- six_3$V1

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V1 means at each V1 threshold
six_3V1.shift <- sapply(cutoff, function(x){mean(six_3V1[six_3V1 > x])})

# Calculate deviation 
(six_3V1.df <- data.frame(time = 'V1',
                           cutoff = cutoff,
                           cutoff2 = cutoff - 0.15,
                           mean = six_3V1.shift) %>% 
        mutate(deviation = mean - mean(six_3V1),
               time = as.character(time)))

# Plot data
ggplot(data = six_3V1.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_3V1), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 5) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'A: Shift in V1 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Model mean of V2 with increasing V1 thresholds from 0 to 5 

```{r three_cutoffV1V2}
# Extract visit 2 data 
six_3V2 <- six_3$V2

# Generate a vector of threshold values to iterate over
cutoff <- 0:5

# Generate a vector of V2 means at each V1 threshold
six_3V2.shift <- map_dbl(.x = cutoff,
                          ~ six_3 %>% 
                              filter(V1 > .x) %>% 
                              .$V2 %>% 
                              mean(.))

# Calculate deviation
(six_3V2.df <- data.frame(time = 'V2',
                           cutoff = cutoff,
                           cutoff2 = cutoff + 0.15,
                           mean = six_3V2.shift) %>% 
        mutate(deviation = mean - mean(six_3V2),
               time = as.character(time)))

# Plot data
ggplot(data = six_3V2.df) +
    aes(x = cutoff, y = mean, ymin = mean(six_3V2), ymax = mean) +
    geom_ribbon(alpha = 0.6) +
    geom_point(size = 3) +
    geom_line(size = 1) +
    geom_text(aes(label = round(mean, 2)), 
              nudge_y = 0.5, size = 5) +
    scale_y_continuous(limits = c(5, 10),
                       breaks = c(0, 2, 4, 6, 8, 10)) +
    labs(title = 'B: Shift in V2 mean with increasing V1 threshold value',
         caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2',
         x = 'Baseline pain intensity threshold',
         y = 'Mean score (0-10 rating scale)') +
    theme(plot.caption = element_text(size = 14))
```

## Placebo response

### threshold: 0

```{r three_threshold0}
# Process data
placebo_3.0 <- six_3 %>% 
    filter(V1 >= 0) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Calculate the mean (95%CI) difference between V1 and V2
diff_3.0 <- groupwiseMean(difference ~ 1,
                          data = placebo_3.0,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_3.0$.id <- 0

kable(diff_3.0)

# Plot the data
ggMarginal(placebo_3.0[, 1:3] %>% 
               bind_rows(six_3) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_3,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_3.0,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_3$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_3.0$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 0, linetype = 2) +
               geom_hline(yintercept = mean(six_3$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_3.0$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'A: Baseline pain threshold = 0',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 3

```{r three_threshold3}
# Process data
placebo_3.3 <- six_3 %>% 
    filter(V1 >= 3) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_3.3 <- groupwiseMean(difference ~ 1,
                          data = placebo_3.3,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_3.3$.id <- 3

kable(diff_3.3)

# Plot the data
ggMarginal(placebo_3.3[, 1:3] %>% 
               bind_rows(six_3) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_3,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_3.3,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_3$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_3.3$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 3, linetype = 2) +
               geom_hline(yintercept = mean(six_3$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_3.3$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'B: Baseline pain threshold = 3',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 4

```{r three_threshold4}
# Process that data
placebo_3.4 <- six_3 %>% 
    filter(V1 >= 4) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_3.4 <- groupwiseMean(difference ~ 1,
                          data = placebo_3.4,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_3.4$.id <- 4

kable(diff_3.4)

# Plot the data
ggMarginal(placebo_3.4[, 1:3] %>% 
               bind_rows(six_3) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_3,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_3.4,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_3$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_3.4$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 4, linetype = 2) +
               geom_hline(yintercept = mean(six_3$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_3.4$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'C: Baseline pain threshold = 4',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

### threshold: 5

```{r three_threshold5}
# Process that data 
placebo_3.5 <- six_3 %>% 
    filter(V1 >= 5) %>% 
    mutate(difference = V1 - V2) %>% 
    mutate(group = 'Threshold')

# Set seed
set.seed(2019)

# Calculate the mean (95%CI) difference between V1 and V2
diff_3.5 <- groupwiseMean(difference ~ 1,
                          data = placebo_3.5,
                          R = 2000,
                          traditional = FALSE,
                          bca = TRUE) 

diff_3.5$.id <- 5

kable(diff_3.5)

# Plot the data
ggMarginal(placebo_3.5[, 1:3] %>% 
               bind_rows(six_3) %>% 
               mutate(group = factor(group, 
                                     levels = c('No threshold', 'Threshold'),
                                     ordered = TRUE)) %>% 
               ggplot(data = .) +
               aes(x = V1, y = V2) +
               geom_point(aes(colour = group, fill = group),
                          size = 1) +
               guides(colour = guide_legend(override.aes = list(size = 8))) +
               geom_point(data = six_3,
                          colour = '#999999',
                          size = 1) +
               geom_point(data = placebo_3.5,
                          size = 1,
                          colour = '#000000') +
               geom_vline(xintercept = mean(six_3$V1),
                          colour = pal[1], size = 1) +
               geom_vline(xintercept = mean(placebo_3.5$V1),
                          colour = pal[2], size = 1) +
               geom_vline(xintercept = 5, linetype = 2) +
               geom_hline(yintercept = mean(six_3$V2),
                          colour = pal[1], size = 1) +
               geom_hline(yintercept = mean(placebo_3.5$V2),
                          colour = pal[2], size = 1) +
               scale_y_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_x_continuous(limits = c(0, 10),
                                  breaks = c(0, 2, 4, 6, 8, 10)) +
               scale_fill_manual(values = pal) +
               scale_colour_manual(values = pal) +
               labs(title = 'D: Baseline pain threshold = 5',
                    caption = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2') +
               theme(legend.title = element_blank(),
                     legend.position = c(0.85, 0.15),
                     plot.caption = element_text(size = 14)),
           groupColour = TRUE,
           groupFill = TRUE)
```

## Publication plots

```{r three_plot0}
# Plot 1
shift_3 <- six_3V1.df %>% 
  bind_rows(six_3V2.df) %>% 
  ggplot(data = .) + 
  aes(y = mean,
      x = cutoff2,
      fill = time) +
  geom_hline(yintercept = 6.2,
             linetype = 2) +
  geom_point(shape = 21,
             size = 8) +
  labs(title = 'C',
       subtitle = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean pain score (0-10 rating scale)') +
  scale_x_continuous(breaks = 0:5) +
  scale_y_continuous(limits = c(4, 10)) +
  scale_fill_manual(values = pal) +
  theme(legend.title = element_blank(),
        legend.position = c(0.12, 0.89),
        legend.text = element_text(size = 20)); shift_3
  
# Plot 2
# Bind diff_*.* dataframes
diff_all_3 <- diff_3.0 %>% 
  bind_rows(diff_3.3, diff_3.4, diff_3.5)

pp_3 <- diff_all_3 %>% 
  mutate(Threshold = factor(.id)) %>% 
  ggplot(data = .) +
  aes(x = Threshold,
      y = Mean,
      ymin = Bca.lower,
      ymax = Bca.upper) +
  geom_hline(yintercept = 0, 
             linetype = 2) +
  geom_errorbar(width = 0.4) +
  geom_point(shape = 21,
             fill = pal[[1]],
             size = 8) +
  labs(title = 'C',
       subtitle = 'Parameters: Mean = 6.2, SD = 2.2, r = 0.2',
       x = 'Baseline pain intensity threshold',
       y = 'Mean difference (V1 - V2)') +
  scale_y_continuous(limits = c(-0.2, 1.8)); pp_3
```

----

# Publication composite plots 

```{r pub_plot}
shift_4 <- shift_1 + shift_2 + shift_3
ggsave('figures/6.2_0.2a.png', shift_4, width = 17, height = 7)

pp_4 <- pp_1 + pp_2 + pp_3
ggsave('figures/6.2_0.2b.png', pp_4, width = 17, height = 7)
```


----

# Session information 

```{r}
sessionInfo()
```